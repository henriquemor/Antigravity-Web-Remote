<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Mobile</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            background: #031f13; 
            display: flex; 
            flex-direction: column;
            min-height: 100vh; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: white;
        }

        /* Top Bar */
        .header {
            background: #1a1a1a;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: sticky;
            top: 0;
            z-index: 110;
            border-bottom: 1px solid #333;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            font-family: monospace;
            color: #888;
        }

        .interval-links {
            display: flex;
            gap: 6px;
        }

        .interval-links a {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }

        .interval-links a.active {
            color: #0f0;
            font-weight: bold;
            text-decoration: underline;
        }

        .controls-main {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        /* Buttons & Inputs */
        .btn {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px 2px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            flex: 0 0 35px;
            -webkit-tap-highlight-color: transparent;
        }

        .btn.active {
            background: #28a745;
            border-color: #218838;
            font-weight: bold;
        }

        input[type="text"] {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #111;
            color: white;
            font-size: 14px;
            min-width: 0;
        }

        #btn-send {
            flex: 0 0 40px;
            background: #28a745;
            border-color: #218838;
        }

        /* Screen Area */
        #screen-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: #042316;
            padding: 10px 0;
            padding-bottom: 300px;
            padding-top: 300px;
        }

        #screen { 
            max-width: 100%; 
            height: auto;
            display: block;
        }

        .update-time {
            color: #0f0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="status-row">
            <div class="interval-links" id="interval-controls">
                <a data-ms="100">100ms</a>
                <a data-ms="500" class="active">500ms</a>
                <a data-ms="1000">1s</a>
                <a data-ms="2000">2s</a>
                <a data-ms="4000">4s</a>
            </div>
            <div><span id="res-info">...</span> | <span id="time-ago" class="update-time">0</span>s</div>
        </div>
        
        <div class="controls-main">
            <button class="btn active" id="btn-left" title="Esquerdo">L</button>
            <button class="btn" id="btn-right" title="Direito">R</button>
            <button class="btn" id="btn-none" title="Desativar">X</button>
            <input type="text" id="text-input" placeholder="Texto...">
            <button class="btn" id="btn-send">OK</button>
        </div>
    </div>

    <div id="screen-container">
        <img id="screen" src="/api/screenshot" alt="Desktop Snapshot">
    </div>

    <script>
        const img = document.getElementById('screen');
        const resInfo = document.getElementById('res-info');
        const timeAgoLabel = document.getElementById('time-ago');
        const textInput = document.getElementById('text-input');
        
        let screenWidth = 1920; 
        let screenHeight = 1080;
        let lastUpdateTimestamp = Date.now();
        let clickMode = 'left';
        let refreshInterval = 500;

        // Timer de segundos desde a última atualização
        setInterval(() => {
            const seconds = Math.floor((Date.now() - lastUpdateTimestamp) / 1000);
            timeAgoLabel.innerText = seconds;
        }, 1000);

        // Seleção de Intervalo
        document.getElementById('interval-controls').addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                refreshInterval = parseInt(e.target.getAttribute('data-ms'));
                document.querySelectorAll('#interval-controls a').forEach(a => a.classList.remove('active'));
                e.target.classList.add('active');
                console.log("Novo intervalo:", refreshInterval);
            }
        });

        const setMode = (mode) => {
            clickMode = mode;
            document.querySelectorAll('.controls-main .btn').forEach(b => {
                if(b.id !== 'btn-send') b.classList.remove('active');
            });
            if (mode === 'left') document.getElementById('btn-left').classList.add('active');
            if (mode === 'right') document.getElementById('btn-right').classList.add('active');
            if (mode === 'none') document.getElementById('btn-none').classList.add('active');
        };

        document.getElementById('btn-left').onclick = () => setMode('left');
        document.getElementById('btn-right').onclick = () => setMode('right');
        document.getElementById('btn-none').onclick = () => setMode('none');

        const sendText = () => {
            const text = textInput.value;
            if (!text) return;
            fetch('/api/type', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            }).then(() => { textInput.value = ''; });
        };

        document.getElementById('btn-send').onclick = sendText;
        textInput.onkeypress = (e) => { if(e.key === 'Enter') sendText(); };

        async function updateInfo() {
            try {
                const r = await fetch('/api/info');
                const data = await r.json();
                screenWidth = data.width;
                screenHeight = data.height;
                resInfo.innerText = `${screenWidth}x${screenHeight}`;
            } catch (e) { resInfo.innerText = "Erro"; }
        }
        updateInfo();

        function refreshFrame() {
            const startTime = Date.now();
            const nextFrame = new Image();
            nextFrame.src = `/api/screenshot?t=${startTime}`;

            nextFrame.onload = () => {
                img.src = nextFrame.src;
                lastUpdateTimestamp = Date.now();
                
                const elapsed = Date.now() - startTime;
                const nextWait = Math.max(50, refreshInterval - elapsed);
                
                setTimeout(refreshFrame, nextWait);
            };

            nextFrame.onerror = () => {
                setTimeout(refreshFrame, 200);
            };
        }
        refreshFrame();

        // Unifica clique para mobile e desktop para evitar duplicidade
        let lastClickTime = 0;
        const handleInteraction = (e) => {
            if (clickMode === 'none') return;

            // Debounce de 200ms para evitar disparos duplos (touchstart + mousedown)
            const now = Date.now();
            if (now - lastClickTime < 200) return;
            lastClickTime = now;

            const rect = img.getBoundingClientRect();
            // Pega coordenadas corretamente independente do evento
            const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
            const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;

            // Se o clique foi fora da imagem real (devido ao padding/container), ignora
            if (clientX < rect.left || clientX > rect.right || clientY < rect.top || clientY > rect.bottom) return;

            const xRatio = (clientX - rect.left) / rect.width;
            const yRatio = (clientY - rect.top) / rect.height;

            const realX = Math.round(xRatio * screenWidth);
            const realY = Math.round(yRatio * screenHeight);

            fetch('/api/click', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x: realX, y: realY, button: clickMode })
            });
        };

        // Adiciona os listeners de forma limpa
        img.addEventListener('touchstart', handleInteraction, { passive: true });
        img.addEventListener('mousedown', handleInteraction);
        img.addEventListener('contextmenu', e => e.preventDefault());

    </script>
</body>
</html>
